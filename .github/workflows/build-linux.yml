name: Build Linux

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Tag to build (e.g. v1.0.0)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_tag || github.ref }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install Poppler and Tesseract
        run: |
          # Install Poppler and Tesseract via apt
          sudo apt-get update
          sudo apt-get install -y poppler-utils tesseract-ocr
          
          # Create directory for Poppler binaries
          mkdir -p poppler_binaries
          
          # Copy Poppler binaries to project directory
          cp /usr/bin/pdf* poppler_binaries/ || true
          
          # Verify Poppler
          ls -la poppler_binaries/
          echo "✓ Poppler installed and copied"
          
          # Create directory for Tesseract and copy installation
          mkdir -p tesseract_binaries/bin
          mkdir -p tesseract_binaries/share/tessdata
          cp /usr/bin/tesseract tesseract_binaries/bin/
          
          # Copy tessdata from the correct location for Ubuntu
          # Try multiple possible locations in order of preference
          if [ -d "/usr/share/tesseract-ocr/5/tessdata" ]; then
            echo "Found tessdata in /usr/share/tesseract-ocr/5/tessdata (Ubuntu 24.04+)"
            cp -r "/usr/share/tesseract-ocr/5/tessdata/"* tesseract_binaries/share/tessdata/
          elif [ -d "/usr/share/tesseract-ocr/4/tessdata" ]; then
            echo "Found tessdata in /usr/share/tesseract-ocr/4/tessdata (Ubuntu 20.04-22.04)"
            cp -r "/usr/share/tesseract-ocr/4/tessdata/"* tesseract_binaries/share/tessdata/
          elif [ -d "/usr/share/tesseract-ocr/4.00/tessdata" ]; then
            echo "Found tessdata in /usr/share/tesseract-ocr/4.00/tessdata"
            cp -r "/usr/share/tesseract-ocr/4.00/tessdata/"* tesseract_binaries/share/tessdata/
          elif [ -d "/usr/share/tessdata" ]; then
            echo "Found tessdata in /usr/share/tessdata"
            cp -r "/usr/share/tessdata/"* tesseract_binaries/share/tessdata/
          else
            echo "ERROR: Could not find tessdata directory!"
            echo "Searching for tessdata..."
            find /usr/share -name "*.traineddata" 2>/dev/null | head -5
            exit 1
          fi
          
          # Verify Tesseract installation
          echo "Verifying Tesseract binary:"
          ls -la tesseract_binaries/bin/
          echo ""
          echo "Verifying tessdata directory:"
          if [ -d "tesseract_binaries/share/tessdata" ]; then
            traineddata_count=$(find tesseract_binaries/share/tessdata -maxdepth 1 -name "*.traineddata" 2>/dev/null | wc -l)
            if [ "$traineddata_count" -eq 0 ]; then
              echo "✗ ERROR: tessdata directory exists but no .traineddata language files were found"
              echo "Contents of tessdata directory (for debugging):"
              ls -la tesseract_binaries/share/tessdata
              exit 1
            fi
            if [ "$traineddata_count" -eq 0 ]; then
              echo "✗ ERROR: tessdata directory exists but no .traineddata language files were found"
              echo "Contents of tessdata directory (for debugging):"
              ls -la tesseract_binaries/share/tessdata
              exit 1
            fi
            echo "✓ tessdata directory exists with $traineddata_count language file(s)"
            echo "Language files:"
            ls tesseract_binaries/share/tessdata/*.traineddata 2>/dev/null | head -5
          else
            echo "✗ ERROR: tessdata directory not found!"
            exit 1
          fi
          echo "✓ Tesseract installed and copied successfully"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build executable
        run: python build.py
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: QuickPdfOcr-Linux
          path: dist/QuickPdfOcr
