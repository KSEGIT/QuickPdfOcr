name: Build Windows

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Tag to build (e.g. v1.0.0)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_tag || github.ref }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Download Poppler for Windows
        run: |
          # Download pre-compiled Poppler binaries from oschwartz10612
          $POPPLER_VERSION = "24.08.0-0"
          $POPPLER_URL = "https://github.com/oschwartz10612/poppler-windows/releases/download/v$POPPLER_VERSION/Release-$POPPLER_VERSION.zip"
          
          Write-Host "Downloading Poppler $POPPLER_VERSION..."
          Invoke-WebRequest -Uri $POPPLER_URL -OutFile poppler.zip
          
          Write-Host "Extracting Poppler..."
          Expand-Archive -Path poppler.zip -DestinationPath poppler_temp
          
          # List extracted contents to see actual structure
          Write-Host "Contents of poppler_temp:"
          Get-ChildItem -Path poppler_temp -Recurse -Depth 1
          
          # Find the actual poppler directory (it might be named differently)
          $popplerDir = Get-ChildItem -Path poppler_temp -Directory | Select-Object -First 1
          
          if ($popplerDir) {
            Write-Host "Moving $($popplerDir.FullName) to poppler_binaries..."
            Move-Item -Path $popplerDir.FullName -Destination poppler_binaries
          } else {
            Write-Error "No directory found in poppler_temp"
            exit 1
          }
          
          # Verify files exist
          if (Test-Path "poppler_binaries/Library/bin/pdfinfo.exe") {
            Write-Host "✓ Poppler binaries downloaded successfully"
            Get-ChildItem "poppler_binaries/Library/bin" | Select-Object -First 5
          } else {
            Write-Error "Failed to download Poppler binaries"
            exit 1
          }
      
      - name: Setup WSL and install packages
        run: |
          Write-Host "Setting up WSL and installing necessary packages..."
          
          # Configuration for WSL setup
          $WSL_SETUP_WAIT_SECONDS = 15
          
          # Check if WSL is available on the runner
          $wslAvailable = Get-Command wsl -ErrorAction SilentlyContinue
          
          if ($wslAvailable) {
            Write-Host "WSL detected, installing packages..."
            
            # Try to set up default WSL distribution if needed
            try {
              wsl --set-default-version 2
              wsl --install --distribution Ubuntu --no-launch
              Start-Sleep -Seconds $WSL_SETUP_WAIT_SECONDS
            } catch {
              Write-Host "Note: WSL setup skipped (may already be configured)"
            }
            
            # Update package lists and install tesseract and poppler in WSL
            try {
              wsl sudo apt-get update
              wsl sudo apt-get install -y tesseract-ocr poppler-utils
              Write-Host "✓ WSL packages installed successfully"
            } catch {
              Write-Host "Warning: Could not install packages in WSL, continuing with native Windows installation"
            }
          } else {
            Write-Host "WSL not available on this runner, skipping WSL package installation"
          }
      
      - name: Install Tesseract via winget with fallback
        run: |
          Write-Host "Installing Tesseract..."
          
          # Configuration
          $WINGET_TIMEOUT_SECONDS = 180  # 3 minute timeout for winget
          
          # Check common installation locations
          $possiblePaths = @(
            "C:\Program Files\Tesseract-OCR",
            "C:\Program Files (x86)\Tesseract-OCR",
            "$env:LOCALAPPDATA\Programs\Tesseract-OCR"
          )
          
          $tesseractPath = $null
          $installSuccess = $false
          
          # Try winget installation with timeout
          Write-Host "Attempting installation via winget (timeout: $WINGET_TIMEOUT_SECONDS seconds)..."
          try {
            $job = Start-Job -ScriptBlock {
              winget install --id UB-Mannheim.TesseractOCR --disable-interactivity --force --silent --accept-source-agreements --accept-package-agreements 2>&1
            }
            
            # Wait for job with timeout
            $completed = Wait-Job -Job $job -Timeout $WINGET_TIMEOUT_SECONDS
            
            if ($completed) {
              $output = Receive-Job -Job $job
              Write-Host "Winget output: $output"
              
              # Verify installation
              Start-Sleep -Seconds 5
              foreach ($path in $possiblePaths) {
                if (Test-Path "$path\tesseract.exe") {
                  Write-Host "✓ Tesseract installed via winget at: $path"
                  $tesseractPath = $path
                  $installSuccess = $true
                  break
                }
              }
            } else {
              Write-Host "⚠️ Winget timed out after $WINGET_TIMEOUT_SECONDS seconds"
              Stop-Job -Job $job
            }
            
            Remove-Job -Job $job -Force
          } catch {
            Write-Host "⚠️ Winget installation failed: $_"
          }
          
          # Fallback to direct download if winget failed
          if (-not $installSuccess) {
            Write-Host "Falling back to direct download method..."
            
            $TESSERACT_URL = "https://digi.bib.uni-mannheim.de/tesseract/tesseract-ocr-w64-setup-5.3.3.20231005.exe"
            
            Write-Host "Downloading Tesseract from: $TESSERACT_URL"
            Invoke-WebRequest -Uri $TESSERACT_URL -OutFile tesseract-installer.exe
            
            Write-Host "Installing Tesseract..."
            Start-Process -FilePath "tesseract-installer.exe" -ArgumentList "/VERYSILENT", "/NORESTART", "/DIR=C:\Tesseract-OCR" -Wait
            
            # Verify installation
            if (Test-Path "C:\Tesseract-OCR\tesseract.exe") {
              $tesseractPath = "C:\Tesseract-OCR"
              Write-Host "✓ Tesseract installed via direct download at: $tesseractPath"
              $installSuccess = $true
            } else {
              # Check alternate locations
              foreach ($path in $possiblePaths) {
                if (Test-Path "$path\tesseract.exe") {
                  Write-Host "✓ Tesseract found at: $path"
                  $tesseractPath = $path
                  $installSuccess = $true
                  break
                }
              }
            }
          }
          
          # Final verification
          if (-not $installSuccess -or -not $tesseractPath) {
            Write-Error "Failed to install Tesseract via both winget and direct download"
            exit 1
          }
          
          Write-Host "✓ Tesseract installation complete at: $tesseractPath"
          
          Write-Host "Copying Tesseract to project directory..."
          New-Item -ItemType Directory -Force -Path tesseract_binaries
          Copy-Item -Path "$tesseractPath\*" -Destination tesseract_binaries -Recurse
          
          # Verify files exist
          if (Test-Path "tesseract_binaries/tesseract.exe") {
            Write-Host "✓ Tesseract binaries copied successfully"
            Get-ChildItem "tesseract_binaries" | Select-Object -First 5
          } else {
            Write-Error "Failed to copy Tesseract binaries"
            exit 1
          }
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build executable
        run: python build.py
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: QuickPdfOcr-Windows
          path: dist/QuickPdfOcr.exe

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/') || inputs.release_tag != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release_tag }}
          files: dist/QuickPdfOcr.exe
          draft: false
          prerelease: false
          generate_release_notes: true
